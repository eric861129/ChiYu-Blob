{{ $uid := substr (md5 (printf "calendar-%d" now.UnixNano)) 0 8 }}
{{ $wrapperId := printf "calendar-widget-%s" $uid }}

<div class="mt-8">
    <h3 class="text-xl font-bold mb-4 pb-2 border-b" style="border-color: var(--border-color);">文章月曆</h3>
    <div id="{{ $wrapperId }}" class="calendar-widget">
        <div class="flex justify-between items-center mb-2 font-semibold">
            <button class="cal-prev px-2 py-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="上個月">&lt;</button>
            <span class="cal-month-year"></span>
            <button class="cal-next px-2 py-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="下個月">&gt;</button>
        </div>
        <div class="grid grid-cols-7 text-center text-xs gap-y-2" style="color: var(--text-secondary);">
            <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
        </div>
        <div class="cal-days grid grid-cols-7 text-center text-sm mt-2 gap-y-2">
        </div>
    </div>
</div>
<script>
(function() {
    const wrapper = document.getElementById('{{ $wrapperId }}');
    if (!wrapper) return;

    const postedDates = {};
    {{ range where (where .Site.RegularPages "Type" "posts") "Date" "le" now }}
        {{ $dateStr := .Date.Format "2006-1-2" }}
        {{ $dailyPath := printf "dates/%s/" (.Date.Format "2006-01-02") }}
        postedDates["{{ $dateStr }}"] = "{{ $dailyPath | relURL }}";
    {{ end }}

    const monthYearEl = wrapper.querySelector('.cal-month-year');
    const daysEl = wrapper.querySelector('.cal-days');
    const prevBtn = wrapper.querySelector('.cal-prev');
    const nextBtn = wrapper.querySelector('.cal-next');

    let currentDate = new Date();

    function renderCalendar(date) {
        const year = date.getFullYear();
        const month = date.getMonth();
        monthYearEl.textContent = `${year} 年 ${month + 1} 月`;
        daysEl.innerHTML = ''; 
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const firstDayOfWeek = firstDayOfMonth.getDay(); 
        for (let i = 0; i < firstDayOfWeek; i++) {
            daysEl.insertAdjacentHTML('beforeend', '<div></div>');
        }
        for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
            const dateString = `${year}-${month + 1}-${day}`;
            if (postedDates[dateString]) {
                daysEl.insertAdjacentHTML('beforeend', `
                    <a href="${postedDates[dateString]}" class="block p-1 rounded-full transition-colors font-bold" style="color: var(--link-color); text-decoration: underline; text-decoration-thickness: 2px;">
                        ${day}
                    </a>
                `);
            } else {
                daysEl.insertAdjacentHTML('beforeend', `<span class="block p-1">${day}</span>`);
            }
        }
    }

    prevBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar(currentDate);
    });

    nextBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar(currentDate);
    });

    renderCalendar(currentDate);
})();
</script>
